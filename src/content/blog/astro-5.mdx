---
title: Astro 5
description: Migration collections en Astro 5
pubDate: 2024-10-09
heroImage: /blog-placeholder-5.jpg
updatedDate: 2024-10-10
---

<div class="text-2xl">Table des matières</div>

<ul>
  {getHeadings().map((heading) => (
    <li>
      <a href={`#${heading.slug}`}>{heading.text}</a>
    </li>
  ))}
</ul>

## Installation

```shell
yarn create astro --ref next
```

J'ai choisi le template de blog et typescript.

Le blog est alors fonctionnel sur `http://localhost:4321` mais il n'utilise pas le fonctionnement d'Astro 5.

Pour utiliser Astro 5, il faut apporter les modifications suivantes :

- modifier le `defineCollection` pour utiliser le nouvel attribut loader.

```ts
const blog = defineCollection({
	// type: 'content', // Avant
	loader: glob({ pattern: "**\/*.{md,mdx}", base: "./src/content/blog" }), // Après
    ...
});
```

- post.slug n'existe plus. Il faut le remplacer par post.id.

`index.astro`

```html
<a href={`/blog/${post.id}/`}>
  <img width={720} height={360} src={post.data.heroImage} alt="" />
  <h4 class="title">{post.data.title}</h4>
  <p class="date">
      <FormattedDate date={post.data.pubDate} />
  </p>
```

- dans `[...slug].astro`, changer slug en id

```ts
export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post) => ({
    params: { slug: post.id },
    props: post,
  }));
}
```

- changer également la fonction render qui n'est plus une méthode de post mais une fonction de `astro:content`

```ts
// const { Content } = await post.render(); // Avant

import { render } from 'astro:content'; // Après
...
const { Content } = await render(post);
```

### Déploiement sur Vercel

Aller sur l'UI de Vercel, se connecter à GitHub et choisir le repository.

Si le site est uniquement statique, il n'y a rien à configurer.

S'il utilise du SSR (``output: "server"` or `output: "hybrid"``) alors un adapter sera nécessaire.

Pour cela, ajouter l'intégration Vercel

```shell
npx astro add vercel
```

### Intégration de React

J'ai ajouté une icône SVG en composant React.

Pour cela, il faut qu'Astro reconnaisse les fichiers .tsx.

Il faut ajouter une intégration Astro pour React.

```shell
yarn astro add react
```

Cela va installer les `dépendances` React, modifier le fichier astro.config.mjs pour prendre en compte les composants React et modifier le fichier tsconfig.json pour reconnaître les fichiers tsx.

### SVG

J'ai pris le code SVG du logo GitHub.

Je l'ai passé sous le site `https://svg2jsx.com/` pour obtenir le code JSX.

```tsx
export function GitHubIcon() {
  return (
    <svg width="32" height="32" ariaHidden="true" viewBox="0 0 16 16">
      <path
        fill="currentColor"
        d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0016 8c0-4.42-3.58-8-8-8z"
      ></path>
    </svg>
  );
}
```

L'attribut ariaHidden est mal formé. Je l'ai corrigé en aria-hidden.
L'attribut fill="currentColor" est pratique pour changer la couleur de l'icone en Tailwind.
Le svg est carré donc facile à styler.
J'ai supprimé les attributs width et height parce qu'ils seront pilotés par Tailwind via un composant parent.

Résultat

```tsx
export function GitHubIcon() {
  return (
    <svg aria-hidden="true" viewBox="0 0 16 16">
      <path
        fill="currentColor"
        d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0016 8c0-4.42-3.58-8-8-8z"
      ></path>
    </svg>
  );
}
```

### Tailwind typography

```shell
yarn add -D @tailwindcss/typography

dans tailwind.config.js
  plugins: [
  require('@tailwindcss/typography'),
  ],
```

### Fonts

Le moyen le plus rapide est d'utiliser [Fontsource](https://fontsource.org/) pour trouver une font qui nous intéresse.
Fontsource simplifie l'ajout de font Google fonts ou autres fonts open-source.
Il fournit des modules npm pour self-host des fonts dans un projet.

Par exemple, la font [Poppins](https://fontsource.org/fonts/poppins).

```shell
yarn add @fontsource/twinkle-star
```

GlobalLayout.astro

```astro
import "@fontsource/poppins"
```

tailwind.config.mjs

```js
import defaultTheme from "tailwindcss/defaultTheme";

/** @type {import('tailwindcss').Config} */
export default {
  content: ["./src/**/*.{astro,html,js,jsx,md,mdx,svelte,ts,tsx,vue}"],
  theme: {
    extend: {
      fontFamily: {
        sans: ["Poppins", ...defaultTheme.fontFamily.sans],
      },
    },
  },
  plugins: [],
};
```

Il ne reste plus qu'à l'utiliser dans un fichier astro.

index.astro

```html
<h4 class="font-slackey text-xl md:text-3xl">{firstPost.data.title}</h4>
```

## ESLint

```shell
❯ yarn add -D eslint eslint-plugin-astro @typescript-eslint/parser eslint-plugin-jsx-a11y
```

eslint.config.mjs

```js
import eslintPluginAstro from "eslint-plugin-astro";

export default [
  // add more generic rule sets here, such as:
  // js.configs.recommended,
  ...eslintPluginAstro.configs.recommended,
  {
    rules: {
      // override/add rules settings here, such as:
      // "astro/no-set-html-directive": "error"
    },
  },
];
```

Dans le settings.json de VSCode

```json
{
  "editor.formatOnSave": true,
  "eslint.validate": [
    "javascript",
    "javascriptreact",
    "astro", // Enable .astro
    "typescript", // Enable .ts
    "typescriptreact" // Enable .tsx
  ]
}
```
